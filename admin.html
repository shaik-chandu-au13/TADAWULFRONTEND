<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>
    <link rel="icon" href="./images/download.png" type="image/x-icon" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .navbar-1 {
        background-color: #152c5e;
        padding: 0.5rem;
      }

      .navbar-1 ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      .navbar-1 ul li {
        float: left;
        margin-right: 20px;
      }

      .navbar-1 ul li a {
        color: white;
        text-decoration: none;
        font-size: 1.2rem;
      }

      #jsonFormSection {
        display: none;
      }

      .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }

      .btn-primary {
        background-color: #007bff;
        border: none;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      #loginSection {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
      }

      #footer-1 {
        background-color: #152c5e;
        color: white;
        text-align: center;
        position: fixed;
        width: 100%;
        bottom: 0;
      }
      .scrollable-container {
        height: 70vh; /* Adjust height as needed */
        overflow-y: auto;
        border: 1px solid #ccc;
      }
      .navbar {
        background-color: white; /* Background color */
        overflow: hidden; /* Ensure content doesn't overflow */
      }

      /* Style the list (remove list-style and padding) */
      .navbar ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      /* Style list items (horizontal layout) */
      .navbar ul li {
        float: left;
      }

      /* Style links within list items */
      .navbar ul li a {
        display: block;
        color: black; /* Link text color */
        text-align: center;
        padding: 14px 16px; /* Padding around links */
        text-decoration: none;
      }

      /* Change link color on hover */
      .navbar ul li a:hover {
        background-color: #152c5e; /* Hover background color */
        color: white; /* Hover text color */
      }
      #admin {
        background-color: #152c5e;
        color: white;
      }
            
      #logoutButton {
        margin: 0 15px 0 0;
        padding: 5px;
      }

    </style>
  </head>

  <body>
    <!-- Header -->
    <header style="background-color: #152c5e;" class="container-fluid p-0 shadow-sm">
      <div class="row align-items-center">
          <!-- Left Image -->
          <div class="col-md-2 text-left">
              <img src="./images/SaudiExchange.jpg" alt="Saudi Exchange Logo" class="img-fluid" style="max-height: 143px;">
          </div>
          <!-- Title and Description -->
          <div class="col-md-8 text-center">
              <h1 style="color: white;" class="fw-bold mb-0">Saudi Exchange Automation Pack Selection</h1>
          </div>
      </div>
      <nav
      class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" style="padding: 1px 0 1px 0 !important;"
    >
      <div class="container" style="max-width: 95%">
        <ul
          class="navbar-nav mr-auto"
          style="
            height: 100%;
            display: flex;
            align-items: center;
            color: rgb(0, 0, 0);
          "
        >
          <li class="nav-item">
            <a
              class="nav-link"
              href="./home_page.html"
              id="runPack"
              style="font-weight: bold; padding: 5px 10px"
              >Run Pack</a
            >
          </li>
          <li class="nav-item">
            <a
              style="font-weight: bold; padding: 5px 10px"
              class="nav-link"
              href="./dashboard.html"
              id="dashboard"
              >Dashboard</a
            >
          </li>
          <li class="nav-item">
            <a
              style="font-weight: bold; padding: 5px 10px"
              id="admin"
              class="nav-link active"
              href="#"
              id="admin"
              >Admin</a
            >
          </li>
        </ul>
      </div>
      <button id="logoutButton" type="button" class="btn btn-danger" onclick="logout()">
        Logout
    </button>
    </nav>
  </header>

    <!-- <div class="navbar-1">
        <ul class="container">
         <ul class="navbar-nav mr-auto" style="height: 100%; display: flex; align-items: center;color: rgb(0, 0, 0);">
                <li class="nav-item">
                    <a class="nav-link " href="./home_page.html" id="runPack" style="font-weight: bold; padding: 5px 10px;">Run Pack</a>
                </li>
                <li class="nav-item">
                    <a style="font-weight: bold; padding: 5px 10px;" class="nav-link " href="./dashboard.html" id="dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a style="font-weight: bold; padding: 5px 10px;" id="admin" class="nav-link active"href="#" id="admin">Admin</a>
                </li>
            </ul>
        </ul>
      </div> -->
    <div class="container-fluid scrollable-container" style="position: relative;">
      <!-- Navbar -->
        <!-- <button id="logoutButton" type="button" class="btn btn-danger" onclick="logout()">
            Logout
        </button> -->
      <!-- Login Section -->
      <div id="loginSection" class="container" style="margin-bottom: 2rem">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <h2 class="text-center mt-5">Login</h2>
            <form id="loginForm" class="bg-light p-4 shadow-sm rounded">
              <div class="mb-3">
                <label for="userId" class="form-label">User ID</label>
                <input
                  type="text"
                  id="userId"
                  class="form-control"
                  placeholder="Enter User ID"
                  required
                />
              </div>
              <div class="mb-3" id="passwordField" style="display: none">
                <label for="password" class="form-label">Password</label>
                <input
                  type="password"
                  id="password"
                  class="form-control"
                  placeholder="Enter Password"
                  required
                />
              </div>
              <div class="d-flex justify-content-center mb-3">
                <button type="button" class="btn btn-primary" onclick="login()">
                  Login
                </button>
              </div>
              <div class="d-flex justify-content-center">
                <p
                  id="loginError"
                  class="text-danger mt-3"
                  style="display: none"
                >
                  Invalid User ID or Password.
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- JSON Form Section -->
      <div id="jsonFormSection" class="container mt-5">
        
        <h2 class="text-center">Manage Run-Pack</h2>
    
        <div class="row">
            <!-- Add Section on the Left -->
            <div class="col-md-6">
                <form id="jsonForm" class="bg-light p-4 shadow-sm rounded">
                    <h4 class="text-center">Add</h4>
                    <div class="mb-3">
                        <label for="newMainCategory" class="form-label">Page</label>
                        <input
                            type="text"
                            id="newMainCategory"
                            class="form-control"
                            placeholder="Enter new or existing page name"
                        />
                    </div>
                    <div class="mb-3">
                        <label for="newMenu" class="form-label">Menu</label>
                        <input
                            type="text"
                            id="newMenu"
                            class="form-control"
                            placeholder="Enter new or existing Menu Name"
                        />
                    </div>
                    <div class="mb-3">
                        <label for="newPages" class="form-label">Sub Menu</label>
                        <input
                            type="text"
                            id="newPages"
                            class="form-control"
                            placeholder="Enter new submenu"
                        />
                    </div>
                    <button
                        type="button"
                        class="btn btn-success w-100 mb-3"
                        onclick="addToJson()"
                    >
                    Add in run-pack list
                    </button>
                </form>
            </div>
    
            <!-- Delete Section on the Right -->
            <div class="col-md-6">
                <form class="bg-light p-4 shadow-sm rounded">
                    <h4 class="text-center">Delete</h4>
                    <div class="mb-3">
                        <label for="selectMainCategory" class="form-label">Select Page</label>
                        <select
                            id="selectMainCategory"
                            class="form-select"
                            onchange="populateMenus()"
                        >
                            <option value="">--Select Page--</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="selectMenu" class="form-label">Select Menu</label>
                        <select
                            id="selectMenu"
                            class="form-select"
                            onchange="populatePages()"
                        >
                            <option value="">--Select Menu--</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="selectPage" class="form-label">Select Sub Menu</label>
                        <select id="selectPage" class="form-select">
                            <option value="">--Select Sub Menu--</option>
                        </select>
                    </div>
                    <button
                        type="button"
                        class="btn btn-danger w-100"
                        onclick="deleteFromJson()"
                    >
                    Delete from run-pack list
                    </button>
                </form>
            </div>
        </div>
    </div>

  <div id="jsonEditSection" class="container mt-1">
    <h2 class="text-center">Manage Mobile Options</h2>

    <div class="row">
      <!-- Section to Add New Models or Versions -->
      <div class="col-md-6">
        <form class="bg-light p-4 shadow-sm rounded">
            <h4 class="text-center">Add Model or Version</h4>
            <div class="mb-3">
                <label for="addSelectOS" class="form-label">Select OS</label>
                <select id="addSelectOS" class="form-select">
                    <option value="">--Select OS--</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="newModel" class="form-label">New Model</label>
                <input type="text" id="newModel" class="form-control" placeholder="Enter new model name">
            </div>
            <div class="mb-3">
                <label for="newVersion" class="form-label">New Version</label>
                <input type="text" id="newVersion" class="form-control" placeholder="Enter new version">
            </div>
            <button type="button" class="btn btn-success w-100" onclick="addModelOrVersion()">
              Add Model or Version
            </button>
        </form>
    </div>
        <!-- Section to Delete Models or Versions -->
        <div class="col-md-6">
            <form class="bg-light p-4 shadow-sm rounded">
                <h4 class="text-center">Delete Model or Version</h4>
                <div class="mb-3">
                    <label for="selectOS" class="form-label">Select OS</label>
                    <select id="selectOS" class="form-select">
                        <option value="">--Select OS--</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="selectModel" class="form-label">Select Model</label>
                    <select id="selectModel" class="form-select">
                        <option value="">--Select Model--</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="selectVersion" class="form-label">Select Version</label>
                    <select id="selectVersion" class="form-select">
                        <option value="">--Select Version--</option>
                    </select>
                </div>
                <button type="button" class="btn btn-danger w-100" onclick="deleteModelOrVersion()">
                    Delete Selected Model or Version
                </button>
            </form>
        </div>

        
    </div>
</div>

  
    
    </div>

    <!-- Footer -->
    <footer id="footer-1">
      <b>Copyright © 2024 - Expleo Solutions Limited</b>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Hardcoded credentials
      const validUser = {
        userId: "admin",
        password: "1234",
      };

      // Function to handle login
      document.getElementById("userId").onchange = function () {
        const enteredUserId = this.value;
        const passwordField = document.getElementById("passwordField");

        // Show password field if user ID is filled
        if (enteredUserId) {
          passwordField.style.display = "block";
        } else {
          passwordField.style.display = "none"; // Hide if user ID is empty
        }
      };

      document.getElementById("userId").addEventListener("input", function () {
    const loginError = document.getElementById("loginError");
    if (loginError.style.display === "block") {
        loginError.style.display = "none"; // Hide error when typing in User ID
    }
});

document.getElementById("password").addEventListener("input", function () {
    const loginError = document.getElementById("loginError");
    if (loginError.style.display === "block") {
        loginError.style.display = "none"; // Hide error when typing in Password
    }
});
document.getElementById("password").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Prevent the default form submission
        login(); // Call the login function
    }
});

function login() {
    const enteredUserId = document.getElementById("userId").value;
    const enteredPassword = document.getElementById("password").value;
    const loginError = document.getElementById("loginError");

    // Reset error display
    loginError.style.display = "none";

    // Validation for User ID
    if (!enteredUserId) {
        loginError.textContent = "Please enter your User ID.";
        loginError.style.display = "block";
        document.getElementById("passwordField").style.display = "none"; // Hide password field
        return;
    }

    // Show password field when User ID is entered
    document.getElementById("passwordField").style.display = "block";

    // Validation for Password
    if (!enteredPassword) {
        loginError.textContent = "Please enter your password.";
        loginError.style.display = "block";
        return;
    }

    // Check credentials
    if (enteredUserId === validUser.userId && enteredPassword === validUser.password) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("jsonFormSection").style.display = "block";
        document.getElementById("jsonEditSection").style.display = "block";
        document.getElementById("logoutButton").style.display = "block";

        
        populateMainCategories(); // Populate categories after login

        // Store login state in sessionStorage
        sessionStorage.setItem("isLoggedIn", "true");
    } else {
        loginError.textContent = "Invalid User ID or Password.";
        loginError.style.display = "block";
    }
}

      let pageData = {};

      fetch("./thisJSONcreatesHomepage.json")
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          pageData = data; // Store the JSON data in pageData
          console.log(pageData); // Use the pageData variable
          // displayJsonData(); // Call your function to display the data
          populateMainCategories(); // Populate categories after fetching data
        })
        .catch((error) => console.error("Error loading JSON:", error));

      // Function to display initial JSON data
      // function displayJsonData() {
      //   document.getElementById("jsonDisplay").textContent = JSON.stringify(
      //     pageData,
      //     null,
      //     2
      //   );
      // }

      function populateMainCategories() {
        const mainCategorySelect =
          document.getElementById("selectMainCategory");
        mainCategorySelect.innerHTML = `<option value="">--Select Page--</option>`;
        for (const category in pageData) {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          mainCategorySelect.appendChild(option);
        }
      }

      function populateMenus() {
        const mainCategory =
          document.getElementById("selectMainCategory").value;
        const menuSelect = document.getElementById("selectMenu");
        menuSelect.innerHTML = `<option value="">--Select Menu--</option>`;
        if (mainCategory && pageData[mainCategory]) {
          for (const menu in pageData[mainCategory]) {
            const option = document.createElement("option");
            option.value = menu;
            option.textContent = menu;
            menuSelect.appendChild(option);
          }
        }
        populatePages(); // Clear pages when changing menu
      }

      function populatePages() {
        const mainCategory =
          document.getElementById("selectMainCategory").value;
        const menu = document.getElementById("selectMenu").value;
        const pageSelect = document.getElementById("selectPage");
        pageSelect.innerHTML = `<option value="">--Select Sub menu--</option>`;
        if (mainCategory && menu && pageData[mainCategory][menu]) {
          pageData[mainCategory][menu].forEach((page) => {
            const option = document.createElement("option");
            option.value = page;
            option.textContent = page;
            pageSelect.appendChild(option);
          });
        }
      }

      // Fetch the JSON data on page load
// Fetch the JSON data on page load and populate options for deletion or addition
document.addEventListener("DOMContentLoaded", () => {
    fetch('/mobileData.json')
        .then(response => response.json())
        .then(data => populateSelectOptions(data))
        .catch(error => console.error('Error fetching JSON data:', error));
});

// Populate only models and versions for selected OS
function populateSelectOptions(data) {
    const osSelect = document.getElementById("selectOS");
    const modelSelect = document.getElementById("selectModel");
    const versionSelect = document.getElementById("selectVersion");
    const addSelectOS = document.getElementById("addSelectOS");

    // Clear existing options
    osSelect.innerHTML = '<option value="">--Select OS--</option>';
    addSelectOS.innerHTML = '<option value="">--Select OS--</option>';
    modelSelect.innerHTML = '<option value="">--Select Model--</option>';
    versionSelect.innerHTML = '<option value="">--Select Version--</option>';

    // Populate OS options separately for each select element
    for (const os in data.mobileOptions) {
        // Create separate options for osSelect
        const osOption1 = document.createElement("option");
        osOption1.value = os;
        osOption1.textContent = os;
        osSelect.appendChild(osOption1);

        // Create separate options for addSelectOS
        const osOption2 = document.createElement("option");
        osOption2.value = os;
        osOption2.textContent = os;
        addSelectOS.appendChild(osOption2);
    }

    // Populate models and versions based on selected OS in osSelect
    osSelect.addEventListener("change", () => {
        const selectedOS = osSelect.value;
        modelSelect.innerHTML = '<option value="">--Select Model--</option>';
        versionSelect.innerHTML = '<option value="">--Select Version--</option>';

        if (selectedOS && data.mobileOptions[selectedOS]) {
            // Populate models
            data.mobileOptions[selectedOS].models.forEach(model => {
                const modelOption = document.createElement("option");
                modelOption.value = model;
                modelOption.textContent = model;
                modelSelect.appendChild(modelOption);
            });

            // Populate versions
            data.mobileOptions[selectedOS].versions.forEach(version => {
                const versionOption = document.createElement("option");
                versionOption.value = version;
                versionOption.textContent = version;
                versionSelect.appendChild(versionOption);
            });
        }
    });
}

      function addToJson() {
        const mainCategory = document
          .getElementById("newMainCategory")
          .value.trim()
          .replace(/\s+/g, "_");
        const menu = document
          .getElementById("newMenu")
          .value.trim()
          .replace(/\s+/g, "_");
        const page = document
          .getElementById("newPages")
          .value.trim()
          .replace(/\s+/g, "_");

        if (mainCategory && menu && page) {
          if (!pageData[mainCategory]) {
            pageData[mainCategory] = {};
          }
          // Check if the page is already added to avoid duplicates
          if (!pageData[mainCategory][menu]) {
            pageData[mainCategory][menu] = [];
          }
          if (!pageData[mainCategory][menu].includes(page)) {
            pageData[mainCategory][menu].push(page); // Add the single page
          }
          // document.getElementById("jsonDisplay").textContent = JSON.stringify(
          //   pageData,
          //   null,
          //   2
          // );
          populateMainCategories();
          alert("Added successfully!");

          // Send updated data to server
          saveJsonData(pageData);
        } else {
          alert("Please fill all fields correctly.");
        }
      }

      async function deleteFromJson() {
        const mainCategory =
          document.getElementById("selectMainCategory").value;
        const menu = document.getElementById("selectMenu").value;
        const page = document.getElementById("selectPage").value;

        // Check if mainCategory is selected
        if (mainCategory) {
          // If only mainCategory is selected, delete the entire category
          if (!menu) {
            delete pageData[mainCategory];
            alert("Main category deleted successfully!");
          }
          // If mainCategory and menu are selected
          else if (menu) {
            // If page is selected, delete that specific page
            if (page) {
              pageData[mainCategory][menu] = pageData[mainCategory][
                menu
              ].filter((p) => p !== page);
              alert("Page deleted successfully!");
            }
            // If no page is selected, delete the entire menu
            else {
              delete pageData[mainCategory][menu];
              alert("Menu deleted successfully!");
            }

            // Check if the main category is now empty and delete it if so
            if (Object.keys(pageData[mainCategory]).length === 0) {
              delete pageData[mainCategory];
              alert("Main category deleted successfully!"); // Optional: you can adjust the message here
            }
          }

          // Update the displayed JSON and repopulate categories
          // document.getElementById("jsonDisplay").textContent = JSON.stringify(
          //   pageData,
          //   null,
          //   2
          // );
          populateMainCategories();

          // Send updated data to server
          saveJsonData(pageData);
        } else {
          alert("Please select a main category to delete.");
        }
      }
      function saveJsonData(pageData) {
        console.log(pageData);
        fetch("http://localhost:8082/update-json", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(pageData), // Send the current JSON data
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log(data.message); // Success message
          })
          .catch((error) => {
            console.error("Error updating JSON:", error);
          });
      }
// Delete model or version
function deleteModelOrVersion() {
    const os = document.getElementById("selectOS").value;
    const model = document.getElementById("selectModel").value;
    const version = document.getElementById("selectVersion").value;

    if (!os || (!model && !version)) {
        alert("Please select an OS and either a model or version to delete.");
        return;
    }

    fetch('/delete-json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ os, model, version })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || data.error);
        refreshOptions();
        document.dispatchEvent(new Event("DOMContentLoaded"));
    })
    .catch(error => console.error('Error:', error));
}
function refreshOptions() {
    fetch('/mobileData.json')
        .then(response => response.json())
        .then(data => populateSelectOptions(data))
        .catch(error => console.error('Error fetching JSON data:', error));
}

// Add new model
function addModelOrVersion() {
    const os = document.getElementById("addSelectOS").value;
    const model = document.getElementById("newModel").value;
    const version = document.getElementById("newVersion").value;
    const type = model ? 'model' : 'version';

    if (!os || (!model && !version)) {
        alert("Please select an OS and enter a model or version.");
        return;
    }

    fetch('/add-json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ os, model, version, type })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || data.error);
        refreshOptions();
        document.dispatchEvent(new Event("DOMContentLoaded"));
    })
    .catch(error => console.error('Error:', error));
}


      function logout() {
        document.getElementById("jsonFormSection").style.display = "none";
        document.getElementById("jsonEditSection").style.display = "none";
        document.getElementById("logoutButton").style.display = "none";

        document.getElementById("loginSection").style.display = "block";
        document.getElementById("userId").value = "";
        document.getElementById("password").value = "";
        document.getElementById("loginError").style.display = "none";

        // Clear login state from sessionStorage
        sessionStorage.removeItem("isLoggedIn");
      }
      
      window.onload = function () {
        if (sessionStorage.getItem("isLoggedIn") !== "true") {
          logout(); // Ensure the user is logged out if not authenticated
        }
      };

      // Logout the user if they navigate away (e.g., using the back button)
      window.onbeforeunload = function () {
        logout();
      };
      // Initialize the page by displaying initial JSON data and populating main categories
      // displayJsonData();
      populateMainCategories();
    </script>
  </body>
</html>
